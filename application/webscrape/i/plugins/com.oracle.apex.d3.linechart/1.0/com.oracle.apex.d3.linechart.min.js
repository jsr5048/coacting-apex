!function(util,server,$,d3){var LEGEND_COLUMN_WIDTH=200,CIRCLE_EXPANSION_FACTOR=2,POINT_TRANSITION_DURATION=200,CHART_LINE_CLASS="a-D3LineChart-line",CHART_AREA_CLASS="a-D3LineChart-area",CHART_POINT_CONTAINER_CLASS="a-D3LineChart-pointContainer",IE_UP_TO_10=/MSIE \d/.test(navigator.userAgent),IE_11_AND_UP=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent),IS_IE=IE_UP_TO_10||IE_11_AND_UP;com_oracle_apex_d3_linechart=function(pRegionId,pOptions){function _numericFormat(valueTemplate){if(valueTemplate&&"friendly"===valueTemplate.toLowerCase())return d3.oracle.fnf();if(valueTemplate&&valueTemplate.length>0){var fixedRegex=/(^"[^"]*")/,formatPrefix="",formatSuffix="";fixedRegex.test(valueTemplate)&&(formatPrefix=fixedRegex.exec(valueTemplate)[0],formatPrefix=formatPrefix.substr(1,formatPrefix.length-2),valueTemplate=valueTemplate.replace(fixedRegex,"")),fixedRegex=/("[^"]*"$)/,fixedRegex.test(valueTemplate)&&(formatSuffix=fixedRegex.exec(valueTemplate)[0],formatSuffix=formatSuffix.substr(1,formatSuffix.length-2),valueTemplate=valueTemplate.replace(fixedRegex,""));var d3formatting=d3.format(valueTemplate);return function(){return formatPrefix+d3formatting.apply(this,arguments)+formatSuffix}}return function(_x){return _x}}function _dateFormat(valueTemplate){return valueTemplate&&"friendly"===valueTemplate.toLowerCase()?gTickIntervalFunction===d3.time.second?d3.format("%H:%M:%S"):gTickIntervalFunction===d3.time.minute?d3.format("%H:%M:%S"):gTickIntervalFunction===d3.time.hour?d3.format("%H:%M:%S"):gTickIntervalFunction===d3.time.month?d3.format("%b %Y"):gTickIntervalFunction===d3.time.year?d3.format("%Y"):d3.time.format("%b %d %Y"):d3.time.format(valueTemplate)}function _initializeTooltip(){gTooltipGenerator=d3.oracle.tooltip().accessors({label:pOptions.tooltipX||pOptions.tooltipSeries?function(d){if(pOptions.tooltipX&&!pOptions.tooltipSeries)return gXValueFormatter("number"===pOptions.xDataType.toLowerCase()?d.x:new Date(d.x));if(!pOptions.tooltipX&&pOptions.tooltipSeries)return d.series;var formattedXValue=gXValueFormatter("number"===pOptions.xDataType.toLowerCase()?d.x:new Date(d.x));return d.series+" ("+formattedXValue+")"}:null,value:pOptions.tooltipY?function(d){return d.y}:null,color:function(){return gTooltipColor},content:function(d){return d.tooltip}}).formatters({value:gYValueFormatter}).transitions({enable:!1}).symbol("circle")}function _initializeLegend(){gAry=d3.oracle.ary().hideTitle(!0).showValue(!1).leftColor(!0).numberOfColumns(3).accessors({color:gLineChart.accessors("color"),label:gLineChart.accessors("series")}),gLegend$=$("<div>"),"TOP"===pOptions.legendPosition?gChart$.before(gLegend$):gChart$.after(gLegend$)}function _detach(bbox){return{x:bbox.x,y:bbox.y,width:bbox.width,height:bbox.height}}function _showTooltip(object,tooltipSelection,d){gIsKeyDownTriggered=!1,gTooltipColor=window.getComputedStyle(object).getPropertyValue("fill"),tooltipSelection.datum(d).call(gTooltipGenerator),gTooltip$.stop().fadeIn(pOptions.transitions?100:0);var rOff=($(object).offset(),$(object).offset()),cOff=gChart$.offset(),rBox=_detach(object.getBBox());gTooltip$.position({my:"center bottom-5",of:gChart$,at:"left+"+Math.round(rOff.left-cOff.left+rBox.width/2)+" top+"+(rOff.top-cOff.top),within:gRegion$,collision:"fit fit"})}function _getSeriesData(data){return oracle.jql().select([function(rows){return gLineChart.accessors("color")(rows[0])},"color"]).from(data).group_by([function(row){return row.series},"series"])()}function _assignThemeRollerClasses(chart){chart.selectAll("."+CHART_POINT_CONTAINER_CLASS+"-dot").each(function(){d3.select(this).classed("u-Color-"+gClassScale(gLineChart.accessors("series").apply(this,arguments))+"-BG--fill",!0).classed("u-Color-"+gClassScale(gLineChart.accessors("series").apply(this,arguments))+"-BG--br",!0)}).classed("."+CHART_POINT_CONTAINER_CLASS+"-dot",function(d){return d.link&&d.link.length>1}),chart.selectAll("."+CHART_AREA_CLASS).each(function(){d3.select(this).classed("u-Color-"+gClassScale(gLineChart.accessors("series").apply(this,arguments))+"-BG--fill",!0)}),chart.selectAll("."+CHART_LINE_CLASS).each(function(){d3.select(this).classed("u-Color-"+gClassScale(gLineChart.accessors("series").apply(this,arguments))+"-BG--br",!0)})}function _leftRightArrowKeyAction(chartPointDotClass,object,key){gIsKeyDownTriggered=!0,37===key?gFocusedPoint?gFocusedPoint.prev().length>0?(gFocusedPoint.blur(),gFocusedPoint=gFocusedPoint.prev().focus()):(gFocusedPoint.blur(),gFocusedPoint=$(gFocusedPoint.parent().get(0).querySelectorAll(chartPointDotClass)).last().focus()):gFocusedPoint=$(object.querySelectorAll(chartPointDotClass)).last().focus():39===key&&(gFocusedPoint?gFocusedPoint.next().length>0?(gFocusedPoint.blur(),gFocusedPoint=gFocusedPoint.next().focus()):(gFocusedPoint.blur(),gFocusedPoint=$(gFocusedPoint.parent().get(0).querySelectorAll(chartPointDotClass)).first().focus()):gFocusedPoint=$(object.querySelectorAll(chartPointDotClass)).first().focus())}function _upDownArrowKeyAction(chartPointDotClass,object,key){if(gIsKeyDownTriggered=!0,gFocusedPoint){38===key?0===gObjectIndex?gObjectIndex=gSeries.length-1:gObjectIndex--:40===key&&(gObjectIndex===gSeries.length-1?gObjectIndex=0:gObjectIndex++);var xValueOfdotToBeSelected=d3.select(gFocusedPoint.get(0)).datum().x,dotsSelection=gSeriesSelection.filter(function(d){return d.series===gSeries[gObjectIndex].series}).selectAll(chartPointDotClass),dotSelected=dotsSelection.filter(function(d){return d.x===xValueOfdotToBeSelected})[0][0];dotSelected?(gFocusedPoint.blur(),gFocusedPoint=$(dotSelected).focus()):(gFocusedPoint.blur(),gFocusedPoint=$(dotsSelection[0][0]).first().focus())}else gFocusedPoint.blur(),gFocusedPoint=$(object.querySelectorAll(chartPointDotClass)).first().focus()}function _addKeyBoardSupport(){var chartPointDotClass="."+CHART_POINT_CONTAINER_CLASS+"-dot",isFocused=!1;$("svg",gChart$).first().attr("tabindex",0).on("focusin",function(){isFocused=!0}).on("keydown",function(e){switch(e.which){case 37:_leftRightArrowKeyAction(chartPointDotClass,this,e.which);break;case 38:_upDownArrowKeyAction(chartPointDotClass,this,e.which);break;case 39:_leftRightArrowKeyAction(chartPointDotClass,this,e.which);break;case 40:_upDownArrowKeyAction(chartPointDotClass,this,e.which)}}).on("focusout",function(e){if(0===$("circle:focus, svg:focus",gChart$).length){isFocused=!1;if(d3.select(gChart$.get(0)).selectAll(chartPointDotClass).attr("opacity",1),IS_IE){var chartSelection=d3.select(gChart$.get(0)),focusClass="stacked"===pOptions.display.toLowerCase()?"--fade-stacked":"--fade";chartSelection.selectAll("."+CHART_LINE_CLASS).classed(CHART_LINE_CLASS+focusClass,!1),chartSelection.selectAll("."+CHART_AREA_CLASS).classed(CHART_AREA_CLASS+focusClass,!1),chartSelection.selectAll("."+CHART_POINT_CONTAINER_CLASS).classed(CHART_POINT_CONTAINER_CLASS+focusClass,!1),d3.select(gFocusedPoint.get(0)).transition().duration(POINT_TRANSITION_DURATION).attr("r",function(d){return d.$radius}),gFocusedPoint=null,gTooltip$.hide()}}});$(document).on("keydown",function(e){isFocused&&e.which>=37&&e.which<=40&&e.preventDefault()}),gHasHookedEvents=!0}function _init(pRegionId,pOptions){function _pointEnterEvent(object){gTooltip$.stop().fadeIn(pOptions.transitions?100:0),gHoveredPoint=object}function _pointFocusEvent(object,d,focusClass){d3.select(object).transition().duration(POINT_TRANSITION_DURATION).attr("r",d.$radius*CIRCLE_EXPANSION_FACTOR),gCurrentSeries=d.series,chartSelection.selectAll("."+CHART_LINE_CLASS).sort(function(d){return d.series!==gCurrentSeries?-1:1}).classed(CHART_LINE_CLASS+focusClass,function(d){return d.series!==gCurrentSeries}),chartSelection.selectAll("."+CHART_AREA_CLASS).classed(CHART_AREA_CLASS+focusClass,function(d){return d.series!==gCurrentSeries}),chartSelection.selectAll("."+CHART_POINT_CONTAINER_CLASS).sort(function(d){return d.series!==gCurrentSeries?-1:1}).classed(CHART_POINT_CONTAINER_CLASS+focusClass,function(d){return d.series!==gCurrentSeries})}function _pointOverEvent(object,d,focusClass){gFocusedPoint&&gFocusedPoint.blur(),d3.select(object).transition().duration(POINT_TRANSITION_DURATION).attr("r",d.$radius*CIRCLE_EXPANSION_FACTOR),gHoveredPoint=object,gTooltipColor=window.getComputedStyle(object).getPropertyValue("fill"),tooltipSelection.datum(d).call(gTooltipGenerator),gTooltip$.is(":visible")||gTooltip$.fadeIn(),gTooltip$.position({my:"left+20 center",of:d3.event,at:"right center",within:gRegion$,collision:"flip fit"})}function _pointLeaveEvent(object,d){gHoveredPoint=null,gTooltip$.stop().fadeOut(pOptions.transitions?100:0),d3.select(object).transition().duration(POINT_TRANSITION_DURATION).attr("r",d.$radius)}function _pointBlurEvent(object,d,focusClass){gHoveredPoint||gTooltip$.stop().fadeOut(pOptions.transitions?100:0),chartSelection.selectAll("."+CHART_LINE_CLASS).classed(CHART_LINE_CLASS+focusClass,!1),chartSelection.selectAll("."+CHART_AREA_CLASS).classed(CHART_AREA_CLASS+focusClass,!1),chartSelection.selectAll("."+CHART_POINT_CONTAINER_CLASS).classed(CHART_POINT_CONTAINER_CLASS+focusClass,!1),d3.select(object).transition().duration(POINT_TRANSITION_DURATION).attr("r",d.$radius)}gOptions=pOptions,gRegion$=$("#"+util.escapeCSS(pRegionId),apex.gPageContext$),gChart$=$("#"+util.escapeCSS(pOptions.chartRegionId),apex.gPageContext$);var colorScale=pOptions.colors?d3.scale.ordinal().range(pOptions.colors.split(":")):void 0;switch(gXValueFormatter="number"===pOptions.xDataType.toLowerCase()?_numericFormat(pOptions.xValueTemplate):_dateFormat(pOptions.xValueTemplate),gClassScale=d3.scale.ordinal().range(d3.range(1,16)),gYValueFormatter=_numericFormat(pOptions.yValueTemplate),pOptions.xTickInterval){case"SECOND":gTickIntervalFunction=d3.time.second;break;case"MINUTE":gTickIntervalFunction=d3.time.minute;break;case"HOUR":gTickIntervalFunction=d3.time.hour;break;case"DAY":gTickIntervalFunction=d3.time.day;break;case"WEEK":gTickIntervalFunction=d3.time.week;break;case"SUNDAY":gTickIntervalFunction=d3.time.sunday;break;case"MONDAY":gTickIntervalFunction=d3.time.monday;break;case"TUESDAY":gTickIntervalFunction=d3.time.tuesday;break;case"WEDNESDAY":gTickIntervalFunction=d3.time.wednesday;break;case"THURSDAY":gTickIntervalFunction=d3.time.thursday;break;case"FRIDAY":gTickIntervalFunction=d3.time.friday;break;case"SATURDAY":gTickIntervalFunction=d3.time.saturday;break;case"MONTH":gTickIntervalFunction=d3.time.month;break;case"YEAR":gTickIntervalFunction=d3.time.year;break;default:gTickIntervalFunction="auto"}if(gLineChart=d3.oracle.linechart().margin("left","auto").margin("right","auto").margin("bottom","auto").timeData("date"===pOptions.xDataType.toLowerCase()||"timestamp"===pOptions.xDataType.toLowerCase()||"timestamp_tz"===pOptions.xDataType.toLowerCase()||"timestamp_ltz"===pOptions.xDataType.toLowerCase()).accessors("color",function(d){var s=gLineChart.accessors("series").apply(this,arguments);return colorScale?colorScale(s):gColorMapping[s]||null}).heightMode((pOptions.heightMode||"chart").toLowerCase()).xFormatter(gXValueFormatter).lineInterpolation(pOptions.interpolation).transitions("enable",!!pOptions.transitions).dotRadius("max",2.5).dotRadius("min",1).dotRadius("size","auto").dotRadius("spacing",.6).accessors("key",function(d){return typeof d.series+":"+d.series+"||"+typeof d.x+":"+d.x}).xAxis({title:pOptions.xAxisTitle||"",formatter:gXValueFormatter,grid:pOptions.xGrid,ticksInterval:gTickIntervalFunction,ticksIntervalStep:1}).yAxis({title:pOptions.yAxisTitle||"",formatter:gYValueFormatter}),$(window).on("apexwindowresized",function(){_draw(gData)}),pOptions.showLegend&&_initializeLegend(),pOptions.showTooltip){_initializeTooltip(),gTooltip$=$("<div>").addClass("a-D3LineChart-tooltip a-D3Tooltip").appendTo(gChart$).hide();var focusClass="stacked"===pOptions.display.toLowerCase()?"--fade-stacked":"--fade",chartSelection=d3.select(gChart$.get(0)),tooltipSelection=d3.select(gTooltip$.get(0));gLineChart.on("pointenter",function(d){_pointEnterEvent(this)}).on("pointfocus",function(d){_pointFocusEvent(this,d,focusClass),(this!==gHoveredPoint||gIsKeyDownTriggered)&&_showTooltip(this,tooltipSelection,d)}).on("pointover",function(d){_pointOverEvent(this,d,focusClass)}).on("pointleave",function(d){_pointLeaveEvent(this,d)}).on("pointblur",function(d){_pointBlurEvent(this,d,focusClass)})}gRegion$.on("apexrefresh",_refresh).trigger("apexrefresh")}function _recommendedHeight(){var minAR=gOptions.minAR,maxAR=gOptions.maxAR,w=gChart$.width(),h=0===gChart$.height()?w/maxAR:gChart$.height(),ar=w/h;return minAR>ar?h=w/maxAR+1:ar>maxAR&&(h=w/minAR-1),Math.max(gOptions.minHeight,Math.min(gOptions.maxHeight,h))}function _draw(pData){function _renderLegend(width){gAry.numberOfColumns(Math.max(Math.floor(width/LEGEND_COLUMN_WIDTH),1)),d3.select(gLegend$.get(0)).datum(gSeries).call(gAry).selectAll(".a-D3ChartLegend-item").each(function(d,i){d3.select(this).selectAll(".a-D3ChartLegend-item-color").each(function(){for(var self=d3.select(this),colorClass=self.attr("class").match(/u-Color-\d+-BG--bg/g)||[],i=colorClass.length-1;i>=0;i--)self.classed(colorClass[i],!1);self.classed("u-Color-"+gClassScale(d.series)+"-BG--bg",!0)})})}if(gData=pData,gColorMapping={},gData&&gData.colors)for(var i=gData.colors.length-1;i>=0;i--)gColorMapping[gData.colors[i].series]=gData.colors[i].color;var w=gChart$.width(),thresholdW="WINDOW"===pOptions.thresholdOf?$(window).width():gChart$.width();gLineChart.width(w).display(pOptions.display.toLowerCase());var thresholdDefault=pOptions.threshold||480;thresholdDefault>thresholdW&&pOptions.responsive&&gLineChart.yAxis({ticks:"auto"}),gLineChart.height(_recommendedHeight()),gSeries=_getSeriesData(gData.data);var chart=d3.select(gChart$.get(0)).datum(gData.data).call(gLineChart);_assignThemeRollerClasses(chart),pOptions.showLegend&&_renderLegend(w),gSeriesSelection=d3.select(gChart$.get(0)).selectAll("."+CHART_POINT_CONTAINER_CLASS),gObjectIndex=0,gHasHookedEvents||(_addKeyBoardSupport(),IS_IE&&$("circle",gChart$).on("focus",function(){gLineChart.on("pointfocus").call(this,d3.select(this).datum())}).on("blur",function(){console.log("blur"),gLineChart.on("pointblur").call(this,d3.select(this).datum())}))}function _refresh(){server.plugin(gOptions.ajaxIdentifier,{pageItems:gOptions.pageItems},{refreshObject:gRegion$,success:_draw,loadingIndicator:gChart$,loadingIndicatorPosition:"append"})}var gRegion$,gChart$,gTooltip$,gLegend$,gOptions,gLineChart,gData,gColorMapping,gXValueFormatter,gYValueFormatter,gFocusedPoint,gHoveredPoint,gAry,gClassScale,gIsKeyDownTriggered,gCurrentSeries,gSeries,gSeriesSelection,gObjectIndex,gTickIntervalFunction,gTooltipColor,gTooltipGenerator,gHasHookedEvents=!1;_init(pRegionId,pOptions)}}(apex.util,apex.server,apex.jQuery,d3);