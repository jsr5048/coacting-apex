!function(util,server,$,d3){var LEGEND_COLUMN_WIDTH=200,IE_UP_TO_10=/MSIE \d/.test(navigator.userAgent),IE_11_AND_UP=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent),IS_IE=IE_UP_TO_10||IE_11_AND_UP;com_oracle_apex_d3_bubble_start=function(pRegionId,pAjaxId,pColors,pColorsFg,pConfig,pMinAR,pMaxAR,pMinHeight,pMaxHeight,pPageItemsSubmit,pShowTooltip,pTooltipSeries,pTooltipCustom,pTooltipValue,pShowLegend,pSorting,pLegendPosition){function _fireApexEvent(e,d){apex.event.trigger($x(pRegionId),"com_oracle_apex_d3_"+e,d)}function _sortDataToGetGroupings(data){return oracle.jql().select([function(rows){return colorAccessor(rows[0])},"color"]).from(gPack.nodes(data).filter(function(d){return!d.row})).group_by([function(row){return row.COLORVALUE},"classifications"])()}function _assignThemeRollerClassesToObject(object,arguments){d3.select(object).classed("u-Color-"+gClassScale(arguments[0].COLORVALUE)+"-BG--fill",!0)}function _assignFillThemeRollerClass(d){return"u-Color-"+gClassScale(d.COLORVALUE)+"-FG--fill"}function _textEllipsis(object,d){var self=d3.select(object);self.text(d.LABEL);for(var textLength=self.node().getComputedTextLength(),text=self.text();textLength>2*d.r-30&&text.length>0;)text=text.slice(0,-1),self.text(text),textLength=self.node().getComputedTextLength();return text.length<d.LABEL.length&&text.length>0?text+"...":text}function _textInsideBubbles(node){var changedNode=node.append("text").attr("dy",".3em").attr("font-size",config.label_fontsize).attr("font-family",config.label_fontfamily).attr("fill",fgColorAccessor).style("text-anchor","middle").text(function(d){return _textEllipsis(this,d)});return gColorScaleForeground||changedNode.attr("class",_assignFillThemeRollerClass),changedNode}function _initializeLegend(data,width){gAry=d3.oracle.ary().hideTitle(!0).showValue(!1).leftColor(!0).numberOfColumns(Math.max(Math.floor(width/LEGEND_COLUMN_WIDTH),1)).accessors({color:function(d){return d.color},label:function(d){return d.classifications}}).symbol("circle"),d3.select(gLegend$.get(0)).datum(data).call(gAry).selectAll(".a-D3ChartLegend-item").each(function(d,i){d3.select(this).selectAll(".a-D3ChartLegend-item-color").each(function(){for(var self=d3.select(this),colorClass=self.attr("class").match(/u-Color-\d+-BG--bg/g)||[],i=colorClass.length-1;i>=0;i--)self.classed(colorClass[i],!1);self.classed("u-Color-"+gClassScale(d.classifications)+"-BG--bg",!0)})})}function _mouseOverTooltip(object,d){pShowTooltip&&(gTooltipColor=window.getComputedStyle(object.getElementsByTagName("circle")[0]).getPropertyValue("fill"),d3.select(gTooltip$.get(0)).datum(d).call(gTooltipGenerator),gTooltip$.is(":visible")||gTooltip$.fadeIn(),gTooltip$.position({my:"left+20 center",of:d3.event,at:"right center",within:gRegion$,collision:"flip fit"}))}function _mouseOverEffect(node,d){var hlnode=node.filter(function(d1){return d1.ID==d.ID});hlnode.call(function(d){_bringToFront(d)}).style({opacity:config.opacity_highlight}),hlnode.select("circle").transition().duration(config.trdur/2).attr("r",function(d){return d.r+config.circle_highlight_radiusplus}),hlnode.select("text").transition().duration(config.trdur/2).attr("font-size",config.label_fontsize_highlight),_fireApexEvent("mouseover",d)}function _mouseOutEffect(node,d){var hlnode=node.filter(function(d1){return d1.ID==d.ID});hlnode.style({opacity:config.opacity_normal}).call(function(d){_bringToFront(d)}),hlnode.select("circle").transition().duration(config.trdur/2).attr("r",function(d){return d.r}),hlnode.select("text").transition().duration(config.trdur/2).attr("font-size",config.label_fontsize),_fireApexEvent("mouseout",d)}function _hideTooltip(){pShowTooltip&&gTooltip$.stop().fadeOut(100)}function _linkEvent(d){if(d.LINK){var win=apex.navigation.redirect(d.LINK);win.focus()}_fireApexEvent("click",d)}function _bindEvents(node){node.on("mouseenter",function(d){gMouseEnterFlag||(gMouseEnterFlag=!0,_mouseOverTooltip(this,d),_mouseOverEffect(node,d))}),node.on("mousemove",function(d){_mouseOverTooltip(this,d)}),node.on("mouseleave",function(d){gMouseEnterFlag=!1,_hideTooltip(),_mouseOutEffect(node,d)}),node.on("click",function(d){_linkEvent(d)})}function _moveToFrontIE(d){gContainer.selectAll(".com_oracle_apex_d3bubblenode").sort(function(a,b){return a.ID===d.ID?1:b.ID===d.ID?-1:0})}function _bringToFront(d){config.circle_highlight_radiusplus>config.bubble_padding&&(IS_IE?d.each(function(d){_moveToFrontIE(d)}):d.moveToFront())}function _recommendedHeight(){var minAR=pMinAR,maxAR=pMaxAR,w=gChart$.width(),h=0===gChart$.height()?w/maxAR:gChart$.height(),ar=w/h;return minAR>ar?h=w/maxAR+1:ar>maxAR&&(h=w/minAR-1),Math.max(pMinHeight,Math.min(pMaxHeight,h))}function _resizeFunction(){var height=_recommendedHeight();gContainer.attr("height",height);var width=gChart$.width();gContainer.attr("width",width);var node=gContainer.selectAll(".com_oracle_apex_d3bubblenode");gPack.sort(gSortingFunction).size([width-config.circle_highlight_radiusplus,height-config.circle_highlight_radiusplus]).padding(config.bubble_padding),gPack.nodes(gData),node.transition().duration(config.trdur).attr("transform",function(d){return"translate("+d.x+","+d.y+")"}),node.selectAll("circle").transition().duration(config.trdur).attr("r",function(d){return d.r});var classifications=_sortDataToGetGroupings(gData);node.selectAll("text").transition().duration(config.trdur).text(function(d){return _textEllipsis(this,d)});pShowLegend&&pLegendPosition&&_initializeLegend(classifications,width)}function _refreshData(d3json){d3json.row=d3json.row.filter(function(obj){return 0!==obj.SIZEVALUE});for(var i=0;i<d3json.row.length;i++)d3json.row[i].rownum=i;gData=d3json;var width=gChart$.width(),classifications=(_recommendedHeight(),_sortDataToGetGroupings(d3json)),node=gContainer.selectAll(".com_oracle_apex_d3bubblenode").data(gPack.nodes(d3json).filter(function(d){return!d.row}),function(d){return d.ID}),nodeEnter=node.enter().append("g").attr("class","com_oracle_apex_d3bubblenode").attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).attr("style","opacity: "+config.opacity_normal);nodeEnter.append("circle").attr("r","0").style({fill:colorAccessor}).transition().duration(config.trdur).attr("r",function(d){return d.r}),gColorScale||nodeEnter.each(function(d){_assignThemeRollerClassesToObject(this,arguments)});_textInsideBubbles(nodeEnter);pShowTooltip&&gTooltip$.hide(),_bindEvents(nodeEnter),node.select("circle").transition().duration(2*config.trdur).attr("r",function(d){return d.r}).style({fill:colorAccessor}),node.transition().duration(2*config.trdur).attr("transform",function(d){return"translate("+d.x+","+d.y+")"}),node.on("click",function(d){_linkEvent(d)});var textInsideBubble=node.select("text").transition().duration(2*config.trdur).text(function(d){return _textEllipsis(this,d)});gColorScaleForeground||textInsideBubble.attr("class",_assignFillThemeRollerClass),textInsideBubble.each(function(d){d3.select(this).text(function(d){return _textEllipsis(this,d)})}),node.exit().select("text").remove(),node.exit().select("circle").transition().duration(config.trdur).attr("r","0"),node.exit().transition().duration(config.trdur).remove(),pShowLegend&&pLegendPosition&&_initializeLegend(classifications,width)}function _draw(d3json){d3json.row=d3json.row.filter(function(obj){return 0!==obj.SIZEVALUE});for(var i=0;i<d3json.row.length;i++)d3json.row[i].rownum=i;gRegion$=$("#"+pRegionId+"_region"),gChart$=$("#"+pRegionId+"_chart");var gSortingFunction,width=gChart$.width(),height=_recommendedHeight();"D3ASCENDING"==pSorting?gSortingFunction=d3.ascending:"D3DESCENDING"==pSorting?gSortingFunction=d3.descending:"ASCENDING"==pSorting?gSortingFunction=function(a,b){return-(a.value-b.value)}:"DESCENDING"==pSorting&&(gSortingFunction=function(a,b){return a.value-b.value}),gPack=d3.layout.pack().sort(gSortingFunction).size([width-config.circle_highlight_radiusplus,height-config.circle_highlight_radiusplus]).value(function(d){return d.SIZEVALUE}).children(function(d){return d.row}).padding(config.bubble_padding);var classifications=_sortDataToGetGroupings(d3json);gContainer=d3.select(gChart$.get(0)).append("svg").attr("height",height),gContainer.attr("width",width),gData=d3json;var node=gContainer.selectAll(".com_oracle_apex_d3bubblenode").data(gPack.nodes(d3json).filter(function(d){return!d.row})).enter().append("g").attr("class","com_oracle_apex_d3bubblenode").attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).attr("style","opacity: 0.0");node.transition().attr("style","opacity: "+config.opacity_normal).duration(config.trdur),node.append("circle").attr("r",function(d){return d.r}).style({fill:colorAccessor}),gColorScale||node.each(function(d){_assignThemeRollerClassesToObject(this,arguments)});var textInsideBubble=_textInsideBubbles(node);textInsideBubble.each(function(d){d3.select(this).text(function(d){return _textEllipsis(this,d)})}),pShowTooltip&&(gTooltip$=$(document.createElement("div")).addClass("a-D3Tooltip a-D3BubbleChart-tooltip").appendTo(gChart$).hide()),_bindEvents(node),$(window).on("apexwindowresized",_resizeFunction),pShowLegend&&pLegendPosition&&(gLegend$=$(document.createElement("div")),"TOP"==pLegendPosition?gChart$.before(gLegend$):gChart$.after(gLegend$),_initializeLegend(classifications,width)),apex.jQuery("#"+pRegionId).bind("apexrefresh",function(){_getData(_refreshData)}),apex.event.trigger($x(pRegionId),"com_oracle_apex_d3_initialized")}function _getData(f){apex.server.plugin(pAjaxId,{pageItems:pPageItemsSubmit},{success:f,dataType:"json"})}var gRegion$,gChart$,gTooltip$,gLegend$,gContainer,gPack,gTooltipColor,gData,gColorScale,gColorScaleForeground,gAry,gSortingFunction,gMouseEnterFlag,gClassScale=d3.scale.ordinal().range(d3.range(1,16)),gTooltipGenerator=d3.oracle.tooltip().accessors({label:function(d){return pTooltipSeries?d.COLORVALUE:void 0},value:null,color:function(){return gTooltipColor},content:function(d){var string="";return pTooltipCustom&&(string+=d.TOOLTIP+" \n"),pTooltipValue&&(string+=d.SIZEVALUE),string}}).symbol("circle");gColorScale=pColors?d3.scale.ordinal().range(pColors.split(":")):void 0,gColorScaleForeground=pColorsFg?d3.scale.ordinal().range(pColorsFg.split(":")):void 0;var colorAccessor=function(d){return gColorScale?gColorScale(d.COLORVALUE):null},fgColorAccessor=function(d){return gColorScaleForeground?gColorScaleForeground(d.COLORVALUE):null},config={trdur:500,bubble_padding:2.5,opacity_normal:"0.8",opacity_highlight:"1.0",label_fontsize:"11pt",label_fontfamily:"Sans-Serif",label_fontsize_highlight:"13pt",circle_highlight_radiusplus:5},dConfig="";try{dConfig=JSON.parse(pConfig)}catch(e){dConfig={}}for(var attrname in dConfig)config[attrname]=dConfig[attrname];d3.selection.prototype.moveToFront||(d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})}),_getData(_draw)}}(apex.util,apex.server,apex.jQuery,d3);