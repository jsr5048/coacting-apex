apex.model={},function(a,b,c,d){"use strict";function e(a){if("string"==typeof a)return[a,null];if(B(a)&&2===a.length&&"string"==typeof a[0]&&(null===a[1]||"string"==typeof a[1]))return a;throw new Error("Invalid model id")}function f(a,b){return Math.floor(a/b)*b}function g(a){var b,c;if(B(a)){for(c=[],b=0;b<a.length;b++)c.push(g(a[b]));return c}return C(a)?A(!0,{},a):a}function h(a){var b,c;if(B(a))for(c=[],b=0;b<a.length;b++)c[b]=g(a[b]);else{c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=g(a[b]))}return c}function i(a,b,c){var d,e=a._listeners;for(d=0;d<e.length;d++)e[d].onChange(b,c)}function j(a,b,c,d,e){a?b.call(a,c,d,e):b(c,d,e)}function k(a){return"string"==typeof a?a:B(a)?1===a.length?""+a[0]:JSON.stringify(a):a.toString()}function l(a){var b,c,e=a._listeners,f=[],g=[];for(b=0;b<e.length;b++)c=e[b].progressView,c&&c[0].offsetWidth&&c[0].offsetHeight&&(f.push(c),g.push(e[b].progressOptions||null));return 0===f.length?null:function(){var a,b,c=d();for(a=0;a<f.length;a++)b=apex.util.showSpinner(f[a],g[a]),c=c.add(b);return function(){c.remove()}}}function m(a,b,c,d){var e,f;return f=a,d&&(f+=" Server status: "+d),e=new Error(f),b.status>=0&&(e.status=b.status),e}function n(a,b){var c,d;delete a.error,delete a.warning,delete a.message;for(c in a.fields)a.fields.hasOwnProperty(c)&&(d=a.fields[c],b||delete d.changed,delete d.error,delete d.warning,delete d.message)}function o(a,b,c,d,e){var f;return b===-1&&(b=0),c===-1&&(c=b+a*d),f=c-b,b+f/(d+1)*e}function p(a){return new Error("Model has invalid shape for the "+a+" method")}function q(a){var b,c=e(a);return b=w[c[0]],b&&(b=c[1]?b.instances[c[1]]:b.model),b}function r(a,b,c,d){function f(a){for(var b,c=a,d=e(c.modelId());d;){if(d[0]===l[0]&&(d[1]===l[1]||null===l[1]))return!0;d=null,b=c.getOption("parentModel"),b&&(c=q(b),c&&(d=e(b)))}return!1}function g(d){var e=!(!c&&!d._options.regionId);return e&&("change"===a?e=d.isChanged():"error"===a&&(e=d.hasErrors()),e&&b&&(e=f(d))),e}function h(a,b){m.push({id:a,model:b})}function i(a,b){var c;a.model&&g(a.model)&&h(b,a.model);for(c in a.instances)a.instances.hasOwnProperty(c)&&g(a.instances[c])&&h([b,c],a.instances[c])}var j,k,l=d?e(d):null,m=[];if(l||(b=!1),!b&&l&&l[0])k=l[0],j=w[k],j&&(l[1]?j.instances[l[1]]&&g(j.instances[l[1]])&&h([k,l[1]],j.instances[l[1]]):i(j,k));else for(k in w)w.hasOwnProperty(k)&&(j=w[k],i(j,k));return m}function s(a){var b;b=x.indexOf(a),b>=0&&x.splice(b,1)}function t(a){var b;b=x.indexOf(a),b>=0&&x.splice(b,1),x.push(a)}function u(){var a,b;for(a=0;a<x.length;a++)if(b=x[a],!b.isChanged())return b;return null}var v=10,w={},x=[],y=100,z=v,A=d.extend,B=d.isArray,C=d.isPlainObject,D=d.isFunction,E=d.Deferred,F={modelId:function(){return null===this.instance?this.name:[this.name,this.instance]},fetch:function(a,b,c){function d(a){var b,c=q._data;if(0===a)return 0;for(b=a;b<c.length&&void 0!==c[b];b++);return b}var e,g,h,i,j,k,n,o,p,q=this,r=this._options,s=E();if("number"!=typeof a&&(c=b,b=a,a=0),"table"===r.shape){if(p=f(a,r.pageSize),a=d(p),this._haveAllData&&a>=this._data.length||this._masterRecordIsInserted||this._masterRecordIsDeleted)return!1;o=this._getServerOffset(a),n=p+r.pageSize-a,n<r.pageSize&&void 0===this._data[p+r.pageSize]&&(n+=r.pageSize),j={version:r.version,firstRow:o+1,maxRows:n}}else j={version:r.version};return this._requestsInProgress.fetch?null:(k=A({},r.regionData,{id:r.regionId,ajaxIdentifier:r.ajaxIdentifier,fetchData:A({},r.fetchData,j)}),h={regions:[k]},r.pageItemsToSubmit&&(h.pageItems=r.pageItemsToSubmit),this._addParentItems(h.regions[0]),i={},c||(i.loadingIndicator=l(this)),this._requestsInProgress.fetch=!0,e=this._callServer(h,i),e.done(function(b){var c,d=null,e=null,f=null,g=null,h=null;delete q._requestsInProgress.fetch,q._requestsInProgress.abortFetch?(delete q._requestsInProgress.abortFetch,s.reject(m("Error: Aborted when model cleared",{status:0},"abort"))):(c=b.regions[0].fetchedData,"table"===r.shape?(d=c.values,e=c.totalRows,f=c.firstRow-1,g=c.moreData,h=c.dataOverflow):"tree"===r.shape?d=c.root:"record"===r.shape&&(d=c.value),q._addData(a,f,d,e,g,h),s.resolve())}).fail(function(a,b,c){delete q._requestsInProgress.fetch,s.reject(m("Error retrieving data.",a,b,c))}),g=s.promise(),b&&g.always(b),g.always(function(a){q._drainWaiters(a)}),g)},fetchAll:function(a){function b(){var e=c.fetch(d,function(e){e?a({error:e}):(a({offset:d,total:c.getTotalRecords(),done:!1}),d+=f,b())},!0);null===e?setTimeout(function(){b()},500):e===!1&&a({offset:d,total:c.getTotalRecords(),done:!0})}var c=this,d=0,e=this._options,f=e.pageSize;if("table"!==e.shape)throw p("fetchAll");for(;this._data[d];)d+=1;b()},fetchRecords:function(a,b){var c,d,e,f,g,h,i,j,k=this,n=this._options,o=[],q=E();if("record"===n.shape)throw p("fetchRecords");if(void 0===this._identityKeys)throw new Error("Model must have identityField defined");for(c=0;c<a.length;c++)e=this._getIdentity(a[c]),f=this.getRecordMetadata(e),f&&!f.inserted&&o.push({recordId:e,pk:this._getPrimaryKey(a[c])});return 0===o.length?null:(j=A({},n.regionData,{id:n.regionId,ajaxIdentifier:n.ajaxIdentifier,fetchData:A({},n.fetchData,{version:n.version,primaryKeys:o})}),h={regions:[j]},n.pageItemsToSubmit&&(h.pageItems=n.pageItemsToSubmit),this._addParentItems(h.regions[0]),i={loadingIndicator:l(this)},d=this._callServer(h,i),d.done(function(a){var b,c;b=a.regions[0].fetchedData,c=b.values,k._updateData(c),q.resolve()}).fail(function(a,b,c){q.reject(m("Error retrieving data.",a,b,c))}),g=q.promise(),b&&g.always(b),g)},save:function(a){var b,c,d,e,f,g=E();return f={loadingIndicator:l(this)},e={},(c=this.addChangesToSaveRequest(e))?(b=this._callServer(e,f),c(b),b.done(function(a){a.errors?g.reject(a.errors):g.resolve(null,a)}).fail(function(a,b,c){g.reject(m("Error saving data.",a,b,c))}),d=g.promise(),a&&d.always(a),d):null},saveInProgress:function(){return!!this._requestsInProgress.save},addChangesToSaveRequest:function(a){function b(){delete o._requestsInProgress.save,o._changes=o._pendingChanges.concat(o._changes)}function c(a){var b,c,d,e,f,h,i,j=a.record;for(h=a.inserted&&!a.originalId,c=p.recordIsArray?[]:{},b=0;b<s.length;b++)e=s[b],d=j[e],null!==d&&"object"==typeof d&&d.hasOwnProperty("v")&&(d=d.v),i=t[e],a.fields&&a.fields[i]&&a.fields[i].disabled&&(d=""),!h||!o.isIdentityField(i)||a.original&&d!==a.original[e]||(d=""),p.recordIsArray?c.push(g(d)):c[e]=g(d);f=null,a.deleted?f="d":a.inserted?f="i":a.updated&&(f="u"),c[q]||(c[q]={}),f&&(c[q].op=f),c[q].recordId=o._getIdentity(j),a.originalId&&(c[q].originalId=a.originalId),p.saveSelection&&(c[q].sel=a.sel?"Y":"N"),u.push(c)}var d,e,f,h,i,j,k,l,m,n,o=this,p=this._options,q=this._metaKey,r=[],s=[],t={},u=[],v=0;if(p.pageItemsToSubmit&&(h=a.pageItems,h||(h=[],a.pageItems=h),B(h)))for(i=p.pageItemsToSubmit,B(i)||(i=i.replace(/#/g,"").split(/\s*,\s*/)),d=0;d<i.length;d++)h.indexOf(i[d])<0&&h.push(i[d]);if(this._requestsInProgress.save||0===this._changes.length&&!p.saveSelection)return null;for(d in p.fields)p.fields.hasOwnProperty(d)&&(e=p.fields[d],e.virtual||(v+=1),e["volatile"]||e.virtual||(f=p.recordIsArray?e.index:d,s.push(f),t[f]=d,p.recordIsArray&&e.index===this._metaKey&&(q=s.length-1)));for(p.recordIsArray&&s.sort(function(a,b){return a-b}),q||(q=p.recordIsArray?s.length:"_meta"),d=0;d<this._changes.length;d++)j=this._changes[d],j.autoInserted&&!j.updated&&r.push(j.record);for(r.length&&this.deleteRecords(r),d=0;d<this._changes.length;d++)j=this._changes[d],c(j);if(this._pendingChanges=this._changes,this._changes=[],p.saveSelection)for(d in this._selection)this._selection.hasOwnProperty(d)&&(j=this._selection[d],j.inserted||j.deleted||j.updated||c(j));for(k=a.regions,k||(a.regions=k=[]),d=0;d<k.length&&(l=k[d],l.id!==p.regionId);d++)l=null;return l||(l=A({},p.regionData,{id:p.regionId,ajaxIdentifier:p.ajaxIdentifier,saveData:{models:[]}}),k.push(l)),m=l.saveData.models,n=A({},p.saveData,{instance:this.instance,version:p.version,values:u}),this._addParentItems(n),m.push(n),this._requestsInProgress.save=!0,function(a){a.done(function(a){var c,d,e,f,g,h,i;if(o._requestsInProgress.abortSave)delete o._requestsInProgress.abortSave,b();else if(a.errors){for(c=0;c<a.errors.length;c++)h=a.errors[c],h.regionStaticId===p.regionStaticId&&h.recordId&&h.instance==o.instance&&o.setValidity("error",h.recordId,h.columnName||null,h.message);b()}else if(a.regions){for(g=null,c=0;c<a.regions.length;c++){if(e=a.regions[c],e.id===p.regionId){for(f=e.fetchedData.models,d=0;d<f.length;d++)if(f[d].instance==o.instance){g=f[d].values,o._metaKey||(i=p.recordIsArray?v:"_meta"),o._updateData(g,i);break}break}e=null}o._clearChanges("_pendingChanges")}delete o._requestsInProgress.save}).fail(function(a,c,d){b()})}},setData:function(a,b){b=b||0,this._addData(b,b,a,a?a.length:null,!1,!1),i(this,"refresh",{})},clearData:function(){this._clear(),i(this,"refresh",{})},getTotalRecords:function(){var a,b,c=this._options;if("table"===c.shape)return this._haveAllData||"none"===c.paginationType?this._data.length:this._totalRecords<0?this._totalRecords:Math.max(this._data.length,this._totalRecords);if("record"===c.shape)return 1;if("tree"===c.shape){b=0;for(a in this._index)this._index.hasOwnProperty(a)&&(b+=1);return b}},getServerTotalRecords:function(){var a=this._options;return"table"===a.shape?this._totalRecords<0?this._totalRecords:this._totalRecords+this._numInsertedRecords-this._numDeletedRecords:"record"===a.shape?1:"tree"===a.shape?-1:void 0},getDataOverflow:function(){return!!this.dataOverflow},forEach:function(a,b){var c,d,e,f=this,g=this._options,h=this._data;if("record"===g.shape)throw p("forEach");if("tree"===g.shape)c=0,h&&this.walkTree(h,{node:function(d){j(b,a,d,c,f._getIdentity(d)),c+=1}});else for(e=h.length,c=0;c<e;c++)d=h[c],d&&j(b,a,d,c,this._getIdentity(d,c))},transform:function(a,b){function c(a,b){var c;return c=a[b],c||(c={values:{},paths:[]},a[b]=c),c}function d(a,b,d,e,f,g){var h,i,j,k,l,m,n,o,q;if(a){for(l=a.split("/"),m=e,o=null,q=null,j=null,h=0;h<l.length;h++){if(j=l[h],i=p.exec(j)){n=c(g,i[1]),n.paths[b]=l.slice(h+1).join("/");break}o=m,q=j,m.hasOwnProperty(j)||(m[j]={}),m=m[j]}o?(B(o[q])?(k=o[q],k.length=0):k=[],o[q]=k):k=e,f[b]=k}else{if(!B(e))throw new Error("Context must be an array when there is no path");f[b]=e}d&&(n=c(g,d))}function e(){var a,c;for(a=0;a<q.length;a++)c=q[a],d(c.path,a,c.uniqueIndexField,b,t,u)}function f(a,b,c,d,e){var f,g,i;for(f in a)a.hasOwnProperty(f)&&(g=a[f],i=h(g,c,d,e),void 0!==i&&(b[f]=i));return b}function g(a,b,c,d,e){var f,g,i;for(f=0;f<a.length;f++)g=a[f],i=h(g,c,d,e),void 0!==i&&(b[f]=i);return b}function h(a,c,d,e){var h,i,j,k,l=!1;return"string"==typeof a?(h=a.length,j=a.charAt(0),k=a.charAt(h-1),"'"===j&&"'"===k?a.substring(1,h-1):("("===j&&")"===k&&(a=a.substring(1,h-1),l=!0),i=v.getValue(c,a),null!==i&&"object"==typeof i&&i.hasOwnProperty("d")&&(i=l?i.v:i.d),l||!r||null!==i&&""!==i||(i=r),i)):D(a)?a.call(b,v,c,d,e):null===a?a:B(a)?g(a,[],c,d,e):"object"==typeof a?f(a,{},c,d,e):void 0}function i(a,b,c,d){var e,f,g,i=[];if(a)for(a=a.split("/"),e=0;e<a.length;e++)f=a[e],g=p.exec(f),g&&i.push({key:g[1],value:h(g[1],b,c,d)});return i}function j(e,f,g){var j,k,l,m,p,r,w,x,y,z,A;if(!(f<n||o>0&&f>=n+o)&&(a.includeAggregates||!v._metaKey||!e[v._metaKey].agg)&&(!a.filter||a.filter.call(b,v,e,f,g)))for(j=0;j<s;j++)if(r=null,l=q[j],m=t[j],!l.filter||l.filter.call(b,v,e,f,g)){if(l.uniqueIndexField&&(r=u[l.uniqueIndexField],w=h(l.uniqueIndexField,e,f,g),void 0!==r.values[w]))continue;if(p=h(l.item,e,f,g),void 0!==p){if(r)r.values[w]={index:m.length,arrays:[],indexes:{}};else for(x=i(l.path,e,f,g),A=u,k=0;k<x.length;k++)r=c(A,x[k].key),y=r.values[x[k].value],void 0===y&&(y={index:m.length,arrays:[],indexes:{}},z=""===r.paths[j]?[]:{},m.push(z),r.values[x[k].value]=y),z=m[y.index],y.arrays[j]||d(r.paths[j],j,null,z,y.arrays,y.indexes),m=y.arrays[j],A=y.indexes;m.push(p)}}}var k,l,m,n,o,p=/^\[\W*([^ \t\/]+)\W*\]$/,q=a.template,r=a.showNullAs,s=q.length,t=[],u={},v=this;for(null!==b&&"object"==typeof b||(b={}),e(),n=0,a.offset>=0&&(n=a.offset),o=a.fetchData?this._options.pageSize:null,a.count>0&&(o=a.count),a.fetchData?this.forEachInPage(n,o,j):this.forEach(j),k=0;k<s;k++)l=q[k],m=t[k],l.sort&&m.array.sort(l.sort);return b},forEachInPage:function(a,b,d,e){function f(f){var g,h,i=b-(f-a);c.trace("Model: "+m.modelId()+". forEachInPage fetching more data starting at: ",f),m._waitingPages.push({offset:f,callback:d,thisArg:e,next:function(){m.forEachInPage(f,i,d,e)}}),m._requestsInProgress.fetch||(h=m.fetch(f,function(a){a||setTimeout(function(){m._waitingPages.length>0&&(g=m._waitingPages.shift(),g.next())},1)}),h||(m._waitingPages.pop(),j(e,d,null,-1,null)))}var g,h,i,k,l=a,m=this,n=this._options,o=this._data;if("table"!==n.shape)throw p("forEachInPage");if(b>n.pageSize&&(n.pageSize=10*Math.floor((b+9)/10)),"one"===n.paginationType&&(l=a-this._offset),l<0||l>=o.length)return void(this._haveAllData?(j(e,d,null,-1,null),this._drainWaiters()):f(a));for(h=l+b,k=a,g=l;g<h;g++){if(i=o[g],void 0===i)return void(this._haveAllData&&g>=o.length?(j(e,d,null,-1,null),this._drainWaiters()):f(g+this._offset));i&&(j(e,d,i,k,this._getIdentity(i,g)),k+=1)}this._drainWaiters()},indexOf:function(a){var b,c=this._options;if("record"===c.shape)throw p("indexOf");return"tree"===c.shape?(b=this.getRecordMetadata(this._getIdentity(a)),b&&b.parent?b.parent[this._childrenKey].indexOf(a):-1):this._data.indexOf(a)},recordAt:function(a){if("table"!==this._options.shape)throw p("recordAt");return this._data[a]||null},getRecordId:function(a){return this._getIdentity(a)},isIdentityField:function(a){return void 0!==this._identityKeys&&this._identityKeys.indexOf(this.getFieldKey(a))>=0},getRecordMetadata:function(a){var b=this._index[k(a)];return b||null},metadataChanged:function(a,b){var c=this._index[k(a)];c&&i(this,"metaChange",{record:c.record,recordId:a,field:b||null})},getTypeMetadata:function(a){return this._options.types[a]||null},getFieldMetadata:function(a){return this._options.fields[a]||null},getFieldKey:function(a){var b=this._options;if(b.fields.hasOwnProperty(a)&&!b.fields[a].virtual)return b.recordIsArray?b.fields[a].index:a},isChanged:function(){var a,b,c;if(0===this._changes.length)return!1;for(c=0,a=0;a<this._changes.length;a++)b=this._changes[a],b.autoInserted&&!b.updated||(c+=1);return c>0},getChanges:function(){return this._changes},clearChanges:function(){this._clearChanges("_changes")},hasErrors:function(){return this._errors.length>0},getErrors:function(){return this._errors},setSelectionState:function(a,b){var c=k(a),d=this._index[c];d&&(b=!!b,d.sel!==b&&(d.sel=b,b?(this._selection[c]=d,this._selectionCount+=1):(delete this._selection[c],this._selectionCount-=1)))},clearSelection:function(){var a;for(a in this._selection)this._selection.hasOwnProperty(a)&&(this._selection[a].sel=!1);this._selection={},this._selectionCount=0},getSelectedCount:function(){return this._selectionCount},getSelectedRecords:function(){var a,b=this._selection,c=[];for(a in b)b.hasOwnProperty(a)&&c.push(b[a].record);return c},allowEdit:function(a){return this.check("canEdit",a)},allowDelete:function(a){var b=this._options;return"record"!==b.shape&&("tree"!==b.shape||a!==this._data)&&this.check("canDelete",a)},allowAdd:function(a,b,c){var d,e,f,g,h=this._options;if("record"===h.shape)return!1;if(!("tree"!==h.shape||a&&a[this._childrenKey]))return!1;if(f=this.check("canAdd",a,b,c),f&&c&&"tree"===h.shape&&(g=this._getType(a),e=void 0!==g.validChildren?g.validChildren:void 0===h.types["default"].validChildren||h.types["default"].validChildren,e!==!0))for(d=0;d<c.length;d++)if(e.indexOf(c[d][this._typeKey])<0){f=!1;break}return f},allowDrag:function(a){var b=this._options;return"record"!==b.shape&&this.check("canDrag",a)},dragOperations:function(a){var b,c,d,e=this._options;if(a){if(a.length>0&&this._typeKey){for(d=a[0][this._typeKey]||"default",b=1;b<a.length;b++)if((a[b][this._typeKey]||"default")!==d){d="default";break}}else d="default";c=e.types[d].operations&&void 0!==e.types[d].operations.drag?e.types[d].operations.drag:e.types["default"].operations.drag}else c=e.types["default"].operations.externalDrag;return c},check:function(a,b,c,d){var e,f=!1,g=this._options,h=this._getType(b);if(!g.editable||this._masterRecordIsDeleted)return!1;if(b&&(e=this.getRecordMetadata(this._getIdentity(b)))){if(e.deleted||e.agg)return!1;if(e.inserted&&("canEdit"===a||"canDelete"===a))return!0}return e&&void 0!==e[a]?f=e[a]:h.operations&&void 0!==h.operations[a]?f=h.operations[a]:void 0!==g.types["default"].operations[a]&&(f=g.types["default"].operations[a]),D(f)&&(f=f.call(this,b,c,d)),D(g.check)&&(f=g.check(f,a,b,c,d)),f},getValue:function(a,b){var c;return void 0===b&&(b=a,a=this._data),c=this.getFieldKey(b),a[c]},setValue:function(a,b,c,d){function e(a,b){var c,d=a,e=b;if(null!==a&&"object"==typeof a&&a.hasOwnProperty("v")&&(d=a.v,null!==b&&"object"==typeof b&&b.hasOwnProperty("v")&&(e=b.v)),B(d)&&B(e)){if(d.length!==e.length)return!1;for(c=0;c<d.length;c++)if(d[c]!=e[c])return!1;return!0}return d==e}var f,g,j,k,l,m,n,o,p,q,r=this._options,s=!1;if(void 0===c&&(c=b,b=a,a=this._data),j=this.getFieldKey(b),!this.allowEdit(a))throw new Error("Set value not allowed for record.");if(n=this._getIdentity(a),k=this.getRecordMetadata(n),!k)return null;if(r.fields[b].readonly&&!r.fields[b].parentField||k.fields&&k.fields[b]&&k.fields[b].ck)throw new Error("Set value not allowed for field.");if(g=a[j],!e(g,c)){if(!d&&(b===r.sequenceField||b===r.parentIdentityField))if(o=p=q=null,b===r.sequenceField){if("tree"===r.shape?(p=this.parent(),p&&(o=p[this._childrenKey])):o=this._data,o)for(f=0;f<o.length&&!(parseFloat(o[f][this._sequenceKey])>parseFloat(c));f++)q=o[f]}else b===r.parentIdentityField&&(p=this.getRecord(c));if(k.original||(k.original=h(a),s=!0),a[j]=c,m=this._getIdentity(a),m!==n){if(this._index[m])return a[j]=g,s&&delete k.original,"DUP";k.originalId||(k.originalId=n),delete this._index[n],this._index[m]=k,k.sel&&(delete this._selection[n],this._selection[m]=k)}return k.updated||k.deleted||k.inserted||this._addChange(k),k.updated=!0,k.fields||(k.fields={}),l=k.fields[b],l||(l={},k.fields[b]=l),l.changed=!0,(k.error||k.warning)&&this.setValidity("valid",m),i(this,"set",{oldValue:g,oldIdentity:m!==n?n:null,recordId:m,record:a,field:b}),(p||q)&&this.moveRecords([a],p,q),"SET"}return"NC"},getRecordValue:function(a,b){return this.getValue(this.getRecord(a),b)},setRecordValue:function(a,b,c){this.setValue(this.getRecord(a),b,c)},setValidity:function(a,b,c,d){var e,f,g,h,i,j,l,m=this._index[k(b)];if(m&&(c?(m.fields||(m.fields={}),g=m.fields[c],g||(g={},m.fields[c]=g)):g=m,j="valid",l=g.message||d,g.warning&&(j="warning"),g.error&&(j="error"),a!==j||l!==d)){switch(a){case"error":f="error",delete g.warning;break;case"warning":f="warning",delete g.error;break;case"valid":delete g.error,delete g.warning,delete g.message;break;default:throw new Error("Invalid value for pValidity parameter: "+a)}if(f&&(g[f]=!0,g.message=d),h=m.error,!h&&m.fields)for(e in m.fields)if(m.fields.hasOwnProperty(e)&&m.fields[e].error){h=!0;break}h?(i=this._errors.indexOf(m),i>=0&&this._errors.splice(i,1),this._errors.push(m)):this._removeError(m),this.metadataChanged(b,c)}},deleteRecords:function(a){var b,d,e,f,g=[],h=[],j=this._options;if("record"===j.shape)throw p("deleteRecords");for(b=0;b<a.length;b++)f=a[b],e=this._getIdentity(f),d=this.getRecordMetadata(e),d?this.allowDelete(f)?("table"===j.shape&&(this._numDeletedRecords+=1),j.onlyMarkForDelete&&!d.inserted||("table"===j.shape&&d.inserted&&(this._numDeletedRecords-=1,this._numInsertedRecords-=1),this._removeRecord(e,d)),d.inserted?(delete d.inserted,delete d.autoInserted,delete d.updated,this._removeError(d),this._removeChange(d)):(n(d,!0),this._removeError(d),d.deleted=!0,this._addChange(d)),g.push(f),h.push(e)):c.warn("Delete not allowed for record: "+e):c.warn("Record to delete not found: "+e);return g.length>0&&i(this,"delete",{records:g,recordIds:h}),g.length},canRevertRecord:function(a){var b;return b=this.getRecordMetadata(this._getIdentity(a)),!(!b||!b.original&&!b.deleted)},revertRecords:function(a){var b,d,e,f,g,h,j={},k=[],l=[],m=this._options;for(b=0;b<a.length;b++)e=a[b],f=this._getIdentity(e),d=this.getRecordMetadata(f),d?d.original||d.deleted?("table"===m.shape?g=this._data:"tree"===m.shape&&(g=this.parent(d.record)[this._childrenKey]),h=g.indexOf(d.record),d.deleted?("table"===m.shape&&(this._numDeletedRecords-=1),delete d.deleted):(d.originalId&&(this._index[d.originalId]=d,delete this._index[f],d.sel&&(this._selection[d.originalId]=d,delete this._selection[f]),j[f]=d.originalId,delete d.originalId),d.original&&(d.record=d.original,delete d.original),delete d.updated,n(d),this._removeError(d)),this._removeChange(d),e=d.record,g[h]!==e&&(g[h]=e),k.push(e),l.push(f)):c.warn("Nothing to revert for record "+f):c.warn("Record to revert not found: "+f);return k.length>0&&i(this,"revert",{records:k,recordIds:l,newIds:j}),k.length},insertNewRecord:function(a,b,c){var d,e,f,g,h,j,k,l=this._options,m=null;if("record"===l.shape)throw p("insertNewRecord");if(g=this._initRecord(c,null,a),!this.allowAdd(a,"new",[g]))throw new Error("Insert not allowed for new record.");return h="tree"===l.shape?a?a[this._childrenKey]:this._data[this._childrenKey]:this._data,e=0,b&&(m=this._getIdentity(b),d=this.getRecordMetadata(m),d&&(e=h.indexOf(d.record)+1)),this._sequenceKey&&(j=k=-1,e-1>=0&&(j=parseFloat(h[e-1][this._sequenceKey])),e<h.length&&(k=parseFloat(h[e][this._sequenceKey])),g[this._sequenceKey]=""+o(l.sequenceStep,j,k,1,1)),h.splice(e,0,g),f=this._getIdentity(g),d={record:g,inserted:!0},this._index[f]=d,this._addChange(d),"tree"===l.shape?d.parent=a:this._numInsertedRecords+=1,i(this,"insert",{record:g,recordId:f,insertAfterId:m}),f},moveRecords:function(a,b,d){var e,f,g,h,j,k,l,m,n,q,r=this._options,s=[],t=[],u=null;if("record"===r.shape)throw p("moveRecords");for("tree"===r.shape?(b||(b=this._data),h=b[this._childrenKey]):h=this._data,g=0,d&&(u=this._getIdentity(d),f=this.getRecordMetadata(u),f&&(g=h.indexOf(f.record)+1),(!f||g<0)&&(c.warn("AfterRecord not found, move to beginning."),g=0)),this._sequenceKey&&(n=q=-1,g-1>=0&&(n=parseFloat(h[g-1][this._sequenceKey])),g<h.length&&(q=parseFloat(h[g][this._sequenceKey]))),e=0;e<a.length;e++)if(l=a[e],m=this._getIdentity(l),f=this.getRecordMetadata(m)){if("tree"===r.shape){if(j=this.parent(l),!j){c.warn("Move not allowed for root");continue}j=j[this._childrenKey]}else j=h;k=j.indexOf(l),j.splice(k,1),h===j&&k<g&&(g-=1),t.push(l),s.push(m),h.splice(g,0,l),g+=1,this._sequenceKey&&this.setValue(l,r.sequenceField,""+o(r.sequenceStep,n,q,a.length,e+1),!0),"tree"===r.shape&&(f.parent=b,this._parentIdKey&&this.setValue(l,r.parentIdentityField,this._getIdentity(b),!0))}else c.warn("Record to move not found: "+m);return i(this,"move",{records:t,recordIds:s,insertAfterId:u}),s},copyRecords:function(a,b,d){var e,f,g,h,j,k,l,m,n,q,r,s=this,t=this._options,u=[],v=[],w=null;if("record"===t.shape)throw p("copyRecords");for("tree"===t.shape?(n={node:function(a,b){var c,d;b&&(c=s._getIdentity(a),d={record:a,inserted:!0,parent:b},s._index[c]=d,s._addChange(d))}},b||(b=this._data),l=b[this._childrenKey]):l=this._data,g=0,d&&(w=this._getIdentity(d),f=this.getRecordMetadata(w),f&&(g=l.indexOf(f.record)+1),(!f||g<0)&&(c.warn("AfterRecord not found, copy to beginning."),g=0)),this._sequenceKey&&(q=r=-1,g-1>=0&&(q=parseFloat(l[g-1][this._sequenceKey])),g<l.length&&(r=parseFloat(l[g][this._sequenceKey]))),e=0;e<a.length;e++)h=a[e],k=this._getIdentity(h),f=this.getRecordMetadata(k),f?(j=this._initRecord(null,a[e],b),l.splice(g,0,j),g+=1,this._sequenceKey&&(j[this._sequenceKey]=""+o(t.sequenceStep,q,r,a.length,e+1)),m=this._getIdentity(j),v.push(j),u.push(m),f={record:j,inserted:!0},this._index[m]=f,this._addChange(f),"tree"===t.shape?(f.parent=b,this.walkTree(j,n,null)):this._numInsertedRecords+=1):c.warn("Record to copy not found: "+k);return i(this,"copy",{records:v,recordIds:u,insertAfterId:w}),u},root:function(){if("tree"!==this._options.shape)throw p("root");return this._data},child:function(a,b){var c=a[this._childrenKey];if(c)return c[b]},parent:function(a){var b,c;if(this._identityKeys&&(b=this._getIdentity(a),c=this.getRecordMetadata(b),c&&c.hasOwnProperty("parent")))return c.parent?c.parent:null},childCount:function(a){var b=a[this._childrenKey];return null===b?null:b?b.length:0},hasChildren:function(a){var b=a[this._childrenKey];return null===b?null:!!b&&b.length>0},fetchChildNodes:function(a,b){var c,d,e,f,g,h=this,i=this._options,j=E();return g=A({},i.regionData,{id:i.regionId,ajaxIdentifier:i.ajaxIdentifier,fetchData:A({},i.fetchData,{version:i.version,parentId:this._getPrimaryKey(a)})}),e={regions:[g]},i.pageItemsToSubmit&&(e.pageItems=i.pageItemsToSubmit),this._addParentItems(e.regions[0]),f={loadingIndicator:l(this)},c=this._callServer(e,f),c.done(function(b){var c=b[h._childrenKey];h._addData(a,null,c),j.resolve(c.length)}).fail(function(a,b,c){j.reject(m("Error retrieving data.",a,b,c))}),d=j.promise(),b&&d.always(b),d},clearChildNodes:function(a){a[this._childrenKey];a[this._childrenKey]=null},walkTree:function(a,b,c){var d,e,f,g,h;if(void 0===c&&(c=null,e=this._getIdentity(a),e&&(f=this.getRecordMetadata(e),f&&(c=f))),h=b.node(a,c),!h&&(g=a[this._childrenKey],g&&g.length>0)){for(b.beginChildren&&b.beginChildren(a),d=0;d<g.length;d++)this.walkTree(g[d],b,a);b.endChildren&&b.endChildren(a)}},subscribe:function(a){var b=a.viewId;return b||(b="v::"+y,y+=1,a.viewId=b),this._listeners.push(a),b},unSubscribe:function(a){var b;for(b=0;b<this._listeners.length;b++)this._listeners[b].viewId===a&&this._listeners.splice(b,1)},getOption:function(a){var b=this._options[a];if(void 0===b)throw new Error("No such option: "+a);return b},setOption:function(a,b){var d={genIdPrefix:1,pageItemsToSubmit:1,fetchData:1,saveData:1,regionData:1,parentRecordId:1,editable:1,pageSize:1};if(d[a]){if("editable"===a&&!this._options.identityField)throw new Error("An editable model requires an identityField");this._options[a]=b}else c.warn("Option cannot be set: "+a)},_callServer:function(a,c){var d;return d=b.plugin(a,c)},_drainWaiters:function(a){var b,c;for(b=0;b<this._waitingPages.length;b++)if(c=this._waitingPages[b],(this._haveAllData||this._data[c.offset]||a)&&(this._waitingPages.splice(b,1),b-=1,a&&0!==a.status?j(c.thisArg,c.callback,null,-1,null):c.next(),this._requestsInProgress.fetch))return},_getServerOffset:function(a){var b,c,d,e=a-1;for(d=this._data[e];d;){if(b=this._getIdentity(d,e),c=this.getRecordMetadata(b),c&&c.serverOffset>=0)return c.serverOffset+1;e-=1,d=this._data[e]}return a},_clear:function(){var a=this._options;this._requestsInProgress.fetch&&(this._requestsInProgress.abortFetch=!0),this._requestsInProgress.save&&(this._requestsInProgress.abortSave=!0),"table"===a.shape?(this._data=[],a.hasTotalRecords?this._totalRecords=0:this._totalRecords=-1,this._haveAllData=!1,this._offset=0,this._numInsertedRecords=0,this._numDeletedRecords=0,this._masterRecordIsInserted&&(this._haveAllData=!0),this.dataOverflow=!1):this._data=null,this._changes=[],this._errors=[],this._index={},this._selection={},this._selectionCount=0},_saveDataState:function(){this._saveState={_data:this._data,_totalRecords:this._totalRecords,_haveALlData:this._haveAllData,_offset:this._offset,_numInsertedRecords:this._numInsertedRecords,_numDeletedRecords:this._numDeletedRecords,dataOverflow:this.dataOverflow,_changes:this._changes,_errors:this._errors,_index:this._index,_selection:this._selection,_selectionCount:this._selectionCount}},_restoreDataState:function(){var a=this._saveState;this._data=a._data,this._totalRecords=a._totalRecords,this._haveALlData=a._haveAllData,this._offset=a._offset,this._numInsertedRecords=a._numInsertedRecords,this._numDeletedRecords=a._numDeletedRecords,this.dataOverflow=a.dataOverflow,this._changes=a._changes,this._errors=a._errors,this._index=a._index,this._selection=a._selection,this._selectionCount=a._selectionCount},_clearChanges:function(a){var b,c,d,e=[],f=[],g=this._options,h=this[a];for(b=0;b<h.length;b++)c=h[b],d=this._getIdentity(c.record),c.deleted&&g.onlyMarkForDelete&&this._removeRecord(d,c),c.deleted?e.push(d):(c.inserted||c.updated)&&f.push(d),delete c.deleted,delete c.recordId,delete c.inserted,delete c.autoInserted,delete c.updated,delete c.original;this[a]=[],i(this,"clearChanges",{deletedIds:e,changedIds:f})},_addData:function(a,b,d,e,f,g){function h(a,b,c){var d={record:c};v._metaKey&&(A(d,c[v._metaKey]),d.sel="Y"===d.sel,d.agg&&(!a||v._identityKeys&&!c[v._identityKeys[0]])&&(v._assignTempIdentity(c),a=v._getIdentity(c)),d.allowedOperations&&(d.canEdit=!!d.allowedOperations.update,d.canDelete=!!d.allowedOperations["delete"])),void 0!==b&&null!==b&&(d.serverOffset=b),v._index[a]=d,d.sel&&(v._selected[a]=d)}var j,k,l,m,n,o,p,q,r,s,t,u=this._options,v=this;if("table"===u.shape?((0===a&&!this.isChanged()||"none"===u.paginationType)&&this._clear(),"one"===u.paginationType&&(this._offset=a),this._totalRecords=-1,void 0!==e&&null!==e?this._totalRecords=e:u.hasTotalRecords&&c.warn("Model missing total records"),this._haveAllData||f||(this._haveAllData=!0),g&&(this.dataOverflow=!0)):"record"===u.shape&&this._clear(),"tree"===u.shape&&a)p=a,p[this._childrenKey]=d,u.identityField&&v.walkTree(p,{node:function(a,b){var c;b&&(c=v._getIdentity(a),h(c,null,a),v.getRecordMetadata(c).parent=b)}},null),i(this,"addData",{parentNode:p,offset:0,count:d.length});else if(null===this._data||0===this._data.length||"table"!==u.shape||"one"===u.paginationType)c.trace("Model: "+this.modelId()+". add data set: ",a,e,f),this._data=d,this._numInsertedRecords=0,this._numDeletedRecords=0,"record"!==u.shape?(s={offset:0,count:d.length},q=b,this.forEach(function(a,b,c){v._metaKey&&a[v._metaKey].agg?r=null:(r=q,q+=1),h(c,r,a)}),"tree"===u.shape&&this.root()&&u.identityField&&(this.walkTree(this.root(),{node:function(a,b){v.getRecordMetadata(v._getIdentity(a)).parent=b}},null),s.parentNode=null,s.count=1)):u.identityField&&this._data?(s={offset:0,count:1},h(this._getIdentity(this._data),null,this._data)):s={offset:0,count:this._data?1:0},i(this,"addData",s);else{for(c.trace("Model: "+this.modelId()+". add data merge: ",a,e,f),k=a,q=b,t=[],j=0;j<d.length;j++)if(l=d[j],m=this._getIdentity(l,k),this._metaKey&&l[this._metaKey].agg?r=null:(r=q,q+=1),o=this.getRecordMetadata(m)){if(o.updated||o.inserted||o.deleted)continue;n=this._data.indexOf(o.record),this._data[n]=l,o.record=l,o.serverOffset=r,this._metaKey&&A(o,l[this._metaKey]),t.push(m)}else this._data[k]?this._data.splice(k,0,l):this._data[k]=l,k+=1,h(m,r,l);s={offset:a,count:k-a},t.length&&(s.replacedIds=t),i(this,"addData",s)}},_updateData:function(a,b){var c,d,e,f,g,h,j=[],k=[],l=[],m=[],o={},p=b||this._metaKey;for(c=0;c<a.length;c++)d=a[c],h=d[p],f=h?h.recordId:null,h&&f&&h.notFound?(g=this.getRecordMetadata(f),this._removeRecord(f,g),l.push(g.record),m.push(f)):(e=this._getIdentity(d),f===e&&(f=null),g=this.getRecordMetadata(f?f:e),g&&(f&&(o[f]=e,this._index[e]=g,delete this._index[f],delete this._selection[f],this._selectionCount-=1),j.push(d),k.push(f||e),this._data[this._data.indexOf(g.record)]=d,g.record=d,p&&h?(A(!0,g,h),delete g.recordId):b&&(this._options.recordIsArray?d.splice(b,1):delete d[b]),delete g.deleted,delete g.inserted,delete g.autoInserted,delete g.updated,delete g.original,n(g),this._removeError(g),this._removeChange(g)));j.length>0&&i(this,"refreshRecords",{records:j,recordIds:k,newIds:o}),l.length>0&&i(this,"delete",{records:l,recordIds:m})},_initRecord:function(b,c,d){var e,f,g,h,i,j,k,l,m=this._options;if(b)j=b;else{j=m.recordIsArray?[]:{};for(e in m.fields)if(m.fields.hasOwnProperty(e)&&(f=m.fields[e],g=m.recordIsArray?f.index:e,!f.virtual))if(!c||f.noCopy){if(f.parentField&&m.parentModel&&(k||(k=a.get(m.parentModel),k&&!l&&m.parentRecordId&&(l=k.getRecord(m.parentRecordId))),l)){j[g]=k.getValue(l,f.parentField);continue}j[g]=void 0!==f.defaultValue?f.defaultValue:""}else j[g]=c[g];
}if(k&&a.release(m.parentModel),this._identityKeys&&this._assignTempIdentity(j),this._metaKey&&(j[this._metaKey]={}),"tree"===m.shape&&(this._parentIdKey&&(j[this._parentIdKey]=this._getIdentity(d)),i=[],j[this._childrenKey]=i,c&&(h=c[this._childrenKey])))for(e=0;e<h.length;e++)i.push(this._initRecord(null,h[e],j));return j},_assignTempIdentity:function(a){var b;for(b=0;b<this._identityKeys.length;b++)a[this._identityKeys[b]]=this._options.genIdPrefix+this._nextInsertId,this._nextInsertId+=1},_getIdentity:function(a,b){var c,d=null;if(void 0!==this._identityKeys)if(1===this._identityKeys.length)d=a[this._identityKeys[0]]+"";else for(d=[],c=0;c<this._identityKeys.length;c++)d.push(a[this._identityKeys[c]]+"");else null!==b&&void 0!==b&&(d=b+"");return null!==d?k(d):d},_getPrimaryKey:function(a){var b,c;if(void 0!==this._identityKeys)for(c=[],b=0;b<this._identityKeys.length;b++)c.push(a[this._identityKeys[b]]+"");return c},_getType:function(a){var b="default",c=this._options;return a&&void 0!==this._typeKey&&(b=a[this._typeKey],null!==b&&"object"==typeof b&&b.hasOwnProperty("v")&&(b=b.v),b||(b="default")),c.types[b]||c.types["default"]},_getRecordById:function(a){var b=this._index[k(a)];return b?b.record:null},_removeRecord:function(a,b){var c,d,e=this._options;"table"===e.shape?c=this._data:"tree"===e.shape&&(c=b.parent[this._childrenKey],delete b.parent),c.splice(c.indexOf(b.record),1),d=k(a),delete this._index[d],b.sel&&(delete this._selection[d],this._selectionCount-=1)},_addChange:function(a){var b=this._changes.indexOf(a);b>=0&&this._changes.splice(b,1),this._changes.push(a)},_removeChange:function(a){var b=this._changes.indexOf(a);b>=0&&!a.deleted&&!a.updated&&!a.inserted&&this._changes.splice(b,1)},_removeError:function(a){var b=this._errors.indexOf(a);b>=0&&this._errors.splice(b,1)},_addParentItems:function(b){var c,d,e,f,g,h,i={values:[]},j=this._options;if(j.parentModel){for(c in j.fields)j.fields.hasOwnProperty(c)&&(d=j.fields[c],!d.virtual&&d.parentField&&(e||(e=a.get(j.parentModel),e&&!f&&(f=e.getRecord(j.parentRecordId),h=e.getRecordMetadata(j.parentRecordId))),f&&(g={n:d.parentField,v:e.getValue(f,d.parentField)},i.values.push(g))));h&&(h.salt&&(i.salt=h.salt),h["protected"]&&(i["protected"]=h["protected"])),e&&a.release(j.parentModel),b.parentRecordId=j.parentRecordId,i.values.length>0&&(b.parentItems=i)}}},G={shape:"table",recordIsArray:!1,hasTotalRecords:!1,genIdPrefix:"t",regionId:null,ajaxIdentifier:null,pageItemsToSubmit:null,regionData:{},fetchData:{},saveData:{},version:1,parentModel:null,parentRecordId:null,editable:!1,onlyMarkForDelete:!0,identityField:null,typeField:null,childrenField:null,parentIdentityField:null,sequenceField:null,metaField:null,sequenceStep:10,saveSelection:!1,types:{"default":{validChildren:!0,operations:{canAdd:!0,canEdit:!0,canDelete:!0,canDrag:!0,drag:{normal:"move",ctrl:"copy"},externalDrag:{normal:"add"}}}},check:null,sortCompare:null,paginationType:"none",pageSize:100,preFetch:!1},H={table:1,tree:1,record:1},I={none:1,one:1,progressive:1};a.create=function(b,d,f,g,h,j){var k,l,m,n,o,p,q,r,s,t,v,y,C=e(b),D=Object.create(F);if(D.name=C[0],D.instance=C[1],D._requestsInProgress={},D._listeners=[],D._waitingPages=[],m=d.fields,D._options=A(!0,{},G,d),D._options.fields=m,l=D._options,!l.fields)throw new Error("The fields option is required");if(!H[l.shape])throw new Error("Invalid shape option: "+l.shape);if(!I[l.paginationType])throw new Error("Invalid paginationType option: "+l.paginationType);if(l.editable&&!l.identityField)throw new Error("An editable model requires an identityField");if("tree"===l.shape&&!l.childrenField)throw new Error("A tree shaped model requires a childrenField");if("table"===l.shape&&"none"===l.paginationType&&void 0===d.hasTotalRecords&&(l.hasTotalRecords=!0),D._nextInsertId=1e3,l.identityField)if(B(l.identityField))for(D._identityKeys=[],k=0;k<l.identityField.length;k++)D._identityKeys.push(D.getFieldKey(l.identityField[k]));else D._identityKeys=[D.getFieldKey(l.identityField)];if(l.typeField&&(D._typeKey=D.getFieldKey(l.typeField),void 0===D._typeKey))throw new Error("Type field not found: "+l.typeField);if(l.childrenField&&(D._childrenKey=D.getFieldKey(l.childrenField),void 0===D._childrenKey))throw new Error("Children field not found: "+l.childrenField);if(l.parentIdentityField&&(D._parentIdKey=D.getFieldKey(l.parentIdentityField),void 0===D._parentIdKey))throw new Error("Parent identity field not found: "+l.parentIdentityField);if(l.sequenceField&&(D._sequenceKey=D.getFieldKey(l.sequenceField),void 0===D._sequenceKey))throw new Error("Sequence field not found: "+l.sequenceField);if(l.metaField&&(D._metaKey=D.getFieldKey(l.metaField),void 0===D._metaKey))throw new Error("Meta field not found: "+l.metaField);if("record"!==l.shape?l.identityField?D.getRecord=D._getRecordById:D.getRecord=D.recordAt:D.getRecord=function(){return D._data},D._clear(),f?(s="none"!==l.paginationType&&(void 0!==h&&null!==h?h:void 0===g||null===g||f.length<g),D._addData(0,0,f,g,s,j)):null!==g&&void 0!==g&&(D._totalRecords=g),l.parentModel&&l.parentRecordId&&!f&&(y=a.get(l.parentModel))){v=y.getRecordMetadata(l.parentRecordId),v.inserted&&(D._masterRecordIsInserted=!0,D._clear()),v.deleted&&(D._saveDataState(),D._masterRecordIsDeleted=!0,D._clear(),D._addData(0,0,[],0,!1,!1)),p=D._parentFieldsMap={};for(k in l.fields)l.fields.hasOwnProperty(k)&&(o=l.fields[k],o.parentField&&(p[o.parentField]||(p[o.parentField]=[]),p[o.parentField].push(k)));D.parentModelViewId=y.subscribe({onChange:function(b,c){var d,e;if("delete"===b||"revert"===b||"refreshRecords"===b||"clearChanges"===b){for(e=c.recordIds||c.deletedIds,d=0;d<e.length;d++)if(e[d]===l.parentRecordId){"delete"===b?(D._saveDataState(),D._masterRecordIsDeleted=!0,D._clear(),D._addData(0,0,[],0,!1,!1),i(D,"refresh",{})):"revert"!==b&&"refreshRecords"!==b||!D._masterRecordIsDeleted?"refreshRecords"===b&&c.newIds&&c.newIds[D.instance]||"clearChanges"===b&&D._masterRecordIsDeleted&&delete D._saveState:(delete D._masterRecordIsDeleted,D._restoreDataState(),i(D,"refresh",{}));break}"clearChanges"===b&&D._masterRecordIsInserted&&delete D._masterRecordIsInserted}else"set"===b&&(c.oldIdentity||c.recordId)===l.parentRecordId?(q=c.field,q in p&&(n=p[q],r=y.getValue(c.record,q),D.forEach(function(a){var b,d;if(!D._metaKey||!a[D._metaKey].agg)for(b=0;b<n.length;b++)d=n[b],c.oldValue===D.getValue(a,d)&&D.setValue(a,d,r)})),c.oldIdentity&&(l.parentRecordId=c.recordId,a.renameInstance(D.modelId(),c.recordId))):"refresh"===b&&D._masterRecordIsDeleted&&(delete D._masterRecordIsDeleted,D._restoreDataState(),i(D,"refresh",{}))}}),a.release(l.parentModel)}return x.length>=z&&(t=u(),t&&(c.info("Model: cache overflow; remove model from cache: "+t.modelId()),a.destroy(e(t.modelId())))),t=w[C[0]],t||(t={instances:{},instancesRef:{}},w[C[0]]=t),C[1]?(t.instancesRef[C[1]]=1,t.instances[C[1]]=D):(t.modelRef=1,t.model=D),c.info("Model: created model: "+b+" refCount: 1"),D},a.list=function(a,b,c){var d=r(null,c,a,b);return d.map(function(a){return a.id})},a.anyChanges=function(a,b,c){var d=r("change",c,a,b);return d.length>0},a.anyErrors=function(a,b,c){var d=r("error",c,a,b);return d.length>0},a.addChangesToSaveRequest=function(a,b,c){var d,e,f=[],g=r("change",c,!1,b);if(g.length<=0)return null;for(d=0;d<g.length;d++)e=g[d].model.addChangesToSaveRequest(a),e&&f.push(e);return function(a){var b;for(b=0;b<f.length;b++)f[b](a)}},a.save=function(a,c,d,e){var f,g;return a=a||{},c=c||{},f=apex.model.addChangesToSaveRequest(a,d,e),f?(g=b.plugin(a,c),f(g),g):null},a.get=function(a){var b,d,f,g=e(a);return b=w[g[0]],b&&(g[1]?(d=b.instances[g[1]],d&&(f=b.instancesRef[g[1]]+=1)):(d=b.model,d&&(f=b.modelRef+=1)),d&&(s(d),c.info("Model: get model: "+a+" refCount: "+f))),d},a.renameInstance=function(a,b){var d,f,g=e(a);d=w[g[0]],d&&g[1]&&(f=d.instances[g[1]],f.instance=b,delete d.instances[g[1]],d.instances[b]=f,c.info("Model: rename model "+g[0]+" instance: "+g[1]+" to "+b),i(f,"instanceRename",{oldInstance:g[1],newInstance:b}))},a.release=function(b){var d,f,g=e(b);d=w[g[0]],d&&(g[1]?(f=d.instancesRef[g[1]]-=1,d=d.instances[g[1]]):(f=d.modelRef-=1,d=d.model),c.info("Model: release model: "+b+" refCount: "+f),f<=0&&(d._options.parentModel&&q(d._options.parentModel)?(c.info("Model: save in cache model: "+b),t(d)):d.isChanged()||a.destroy(b)))},a.destroy=function(b){function d(d){var e,f;d&&(s(d),d.parentModelViewId&&(f=d._options.parentModel,e=a.get(f),e&&(e.unSubscribe(d.parentModelViewId),a.release(f))),d._data=null,d._index=null,d._selection=null,c.info("Model: destroy model: "+b))}var f,g,h=e(b);if(f=w[h[0]]){if(h[1])d(f.instances[h[1]]),delete f.instancesRef[h[1]],delete f.instances[h[1]];else if(d(f.model),delete f.model,delete f.modelRef,"string"==typeof b&&!h[1])for(g in f.instances)f.instances.hasOwnProperty(g)&&(d(f.instances[g]),delete f.instancesRef[g],delete f.instances[g]);0!==Object.keys(f.instances).length||f.model||delete w[h[0]]}},a.getMaxCachedModels=function(){return z},a.setMaxCachedModels=function(a){z=parseInt(a,10)||v}}(apex.model,apex.server,apex.debug,apex.jQuery);